# Ejemplo análisis exploratorios genómica de poblaciones

## SNPRelate
### Cargar paquetes que se utilizarán
```{r}
library(SNPRelate)
library(ape)
library(snpStats)
```


### Cargar datos
```{r}
##### Para usar con SNPRelate
## Crear datos en formato gds a partir de plink
snpgdsBED2GDS("../data/maices/maicesArtegaetal2015.bed", 
              "../data/maices/maicesArtegaetal2015.fam", 
              "../data/maices/maicesArtegaetal2015.bim", 
              out.gdsfn="../data/maices/maicesArtegaetal2015.gds", 
              option = snpgdsOption(Z=10)) # 10 cromosomas

# Ver resumen (esto no carga el archivo)
snpgdsSummary("../data/maices/maicesArtegaetal2015.gds")

# Cargar archivo para trabajar con el
genofile <- snpgdsOpen("../data/maices/maicesArtegaetal2015.gds")

# Check snp.ids
head(read.gdsn(index.gdsn(genofile, "snp.id")))

# Check sample.ids
head(read.gdsn(index.gdsn(genofile, "sample.id")))

# Obtener nombres muestras del gdsn
sample.id <- read.gdsn(index.gdsn(genofile, "sample.id"))
sample.id

##### Metadata
# load
fullmat<- read.delim(file= "../meta/maizteocintle_SNP50k_meta_extended.txt")

# check
head(fullmat)
nrow(fullmat)
head(fullmat$NSiembra) # corresponde al número del ID de las muestras
head(sample.id)

##### Para usar con ape
plinkraw<-read.PLINK(file= paste0("../data/maices/maicesArtegaetal2015.raw"), map.file=paste0("../data/maices/maicesArtegaetal2015.map"), chunkSize=165, parallel=FALSE)
```


### Explorar datos con árboles NJ

```{r}
## Plot NJ trees
tre<- nj(dist(as.matrix(plinkraw)))
plot(tre, type="unrooted", cex=0.4)

```


**Ejercicio:** Repetir el árbol anterior coloreando un círculo por raza en vez del nombre de la muestra.

```{r, echo=FALSE}
# colorear por raza sin nombres 
palette(rainbow(length(levels(fullmat$Raza))))
plot(tre, type="unrooted", cex=0.5, show.tip=FALSE)
tiplabels(pch=20, col=fullmat$Raza)

```

**Ejercicio:** Repetir el árbol anterior coloreando un círculo por Categoría de Altitud en vez del nombre de la muestra.

```{r, echo=FALSE}
palette(rainbow(length(levels(fullmat$Categ.Altitud))))
plot(tre, type="unrooted", show.tip=FALSE)
tiplabels(pch=20, col=fullmat$Categ.Altitud)
```


### Realizar PCA 

```{r}
# PCA
pca <- snpgdsPCA(genofile, num.thread=2)

# Calcular el % de variación contenido por los primeros componentes
pc.percent <- pca$varprop*100
head(round(pc.percent, 2))

x<-round(pc.percent, 2)
sum(x[1:4])
sum(x[1:10])
sum(x[1:30])


# Poner resultados en df
tab <- data.frame(sample.id = pca$sample.id,
    EV1 = pca$eigenvect[,1],    # the first eigenvector
    EV2 = pca$eigenvect[,2],    # the second eigenvector
    stringsAsFactors = FALSE)
head(tab)

# Plot
plot(tab$EV2, tab$EV1, 
  xlab= paste0("eigenvector 2 explaining ", round(pc.percent, 2)[2], "%"), # agregar % de varaición del componente al texto del eje
  ylab= paste0("eigenvector 1 explaining ", round(pc.percent, 2)[1], "%"))

```

**Ejercicio**: repite el PCA y plot anterior pero utilizando sólo los SNPS con MAF>=0.05

```{r, echo=FALSE}
# PCA
pca <- snpgdsPCA(genofile, num.thread=2, maf=0.05)

# Calcular el % de variación contenido por los primeros componentes
pc.percent <- pca$varprop*100
head(round(pc.percent, 2))

x<-round(pc.percent, 2)
sum(x[1:4])
sum(x[1:10])
sum(x[1:30])


# Poner resultados en df
tab <- data.frame(sample.id = pca$sample.id,
    EV1 = pca$eigenvect[,1],    # the first eigenvector
    EV2 = pca$eigenvect[,2],    # the second eigenvector
    stringsAsFactors = FALSE)
head(tab)

# Plot
plot(tab$EV2, tab$EV1, 
  xlab= paste0("eigenvector 2 explaining ", round(pc.percent, 2)[2], "%"), # agregar % de varaición del componente al texto del eje
  ylab= paste0("eigenvector 1 explaining ", round(pc.percent, 2)[1], "%"))

```


Colorear PCA maíces por raza:

```{r}
# obtner info raza
pop_code <- as.vector(fullmat$Raza) 
palette(rainbow(length(levels(fullmat$Raza))))

# hacer pop_codes raza coincidan con samples
tab <- data.frame(sample.id = pca$sample.id,
    pop = factor(pop_code)[match(pca$sample.id, sample.id)],
    EV1 = pca$eigenvect[,1],    # the first eigenvector
    EV2 = pca$eigenvect[,2],    # the second eigenvector
    stringsAsFactors = FALSE)
head(tab)

# Plot
plot(tab$EV2, tab$EV1, pch=20, col=tab$pop, 
  xlab= paste0("eigenvector 2 explaining ", round(pc.percent, 2)[2], "%"), # agregar % de varaición del componente al texto del eje
  ylab= paste0("eigenvector 1 explaining ", round(pc.percent, 2)[1], "%"))


```

## snpStats

### Cargar paquetes que se utilizarán
```{r}
library(snpStats)
```

Entra a [este tuturial](http://bioconductor.org/packages/release/bioc/vignettes/snpStats/inst/doc/data-input-vignette.pdf), carga los datos utilizando la función read.plink. Luego:

1. Explora el contenido (síntesis) de los datos 
2. Imprime en la consola el MAF de cada loci
3. Revisa la infromación en el map en las primeras líneas (head)
head(maices$map)
4. Haz un subset de los datos para incluir sólo los primeros 1000 SNPs

```{r, echo=FALSE}
# cargar datos
maices <- read.plink("../data/maices/maicesArtegaetal2015.bed", 
                     "../data/maices/maicesArtegaetal2015.bim",
                     "../data/maices/maicesArtegaetal2015.fam") 

# Resumen genotipos
maices$genotypes

# Imprime en la consola el MAF de cada loci
col.summary(maices$genotypes)$MAF

# Revisa la infromación en el map en las primeras líneas (head)
head(maices$map)

# Haz un subset de los datos para incluir sólo los primeros 1000 SNPs
subset <- read.plink("../data/maices/maicesArtegaetal2015.bed", 
                     "../data/maices/maicesArtegaetal2015.bim",
                     "../data/maices/maicesArtegaetal2015.fam", 
                     select.snps=1:1000)

```


Ahora entra a la ayuda de la función `Fst` y utilízala para calcular los Fst entre categorías altitudinales del subset de SNPs que cargamos en el ejercicio anterior. Después realiza una gráfica como la de abajo.

Pistas: 1) ¿Qué es una SNPMatrix y dónde está en los datos que cargamos?. 2) necesitarás el archivo `maizteocintle_SNP50k_meta_extended.txt` que antes cargamos como `fullmat`.

```{r, echo=FALSE}
# estimar Fst
FstCategAlt<-Fst(snps=subset$genotype, group=fullmat$Categ.Altitud)

# plot
plot(x=1:length(FstCategAlt$Fst), y=FstCategAlt$Fst, 
     pch=20, cex=0.8, ylab="Fst por categorías altitudinales")

```


